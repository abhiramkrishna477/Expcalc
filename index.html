<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Budget | AIGFOX ORIGINALS</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- APP STYLES (Dark Theme) --- */
        :root {
            --bg-app: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --whatsapp: #25D366;
            --danger: #ef4444;
            --success: #22c55e;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        #app {
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            padding-bottom: 100px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 24px;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
            font-weight: 600;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 0;
            margin-bottom: 20px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-btn:hover {
            color: var(--text-main);
        }

        .view {
            display: none;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .view.active {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        /* --- DASHBOARD STYLES --- */
        .brand-dashboard {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 30px;
            color: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .db-status {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--text-muted);
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 20px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .status-dot.online {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .status-dot.offline {
            background: var(--danger);
        }

        .brand-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .brand-logo {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.2rem;
            backdrop-filter: blur(5px);
        }

        .brand-stats {
            display: flex;
            justify-content: space-between;
        }

        .stat-item h4 {
            font-size: 0.75rem;
            opacity: 0.8;
            font-weight: 500;
            margin: 0 0 4px 0;
        }

        .stat-item p {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        /* --- ESTIMATE VS ACTUALS TOGGLE --- */
        .toggle-group {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 4px;
            border-radius: 16px;
            display: flex;
            margin-bottom: 20px;
        }

        .toggle-option {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-muted);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .toggle-option.active {
            background: var(--bg-input);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* --- BUDGET DASHBOARD CARD --- */
        .budget-overview {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .budget-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 12px;
        }

        .b-label {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .b-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .progress-track {
            background: rgba(255, 255, 255, 0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 15px;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.5s ease, background-color 0.3s;
        }

        .remaining-text {
            text-align: right;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--success);
        }

        /* --- INPUTS & FORMS --- */
        .btn-add-card {
            background: rgba(99, 102, 241, 0.05);
            border: 1px dashed var(--primary);
            color: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            width: 90%;
            max-width: 400px;
            padding: 24px;
            border-radius: 24px;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.open .modal {
            transform: scale(1);
        }

        .category-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .cat-btn {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 12px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            text-align: center;
        }

        .cat-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 500;
        }

        input,
        select,
        textarea {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid transparent;
            color: white;
            padding: 14px;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
        }

        input:focus {
            border-color: var(--primary);
        }

        input[readonly] {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-muted);
        }

        .logistics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 24px;
        }

        .expense-row {
            display: grid;
            grid-template-columns: 1fr 100px 40px;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
        }

        .expense-row label {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .expense-row input {
            padding: 10px;
            text-align: right;
        }

        .btn-del {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            opacity: 0.6;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-del:hover {
            opacity: 1;
        }

        .btn-add-expense {
            background: transparent;
            border: 1px dashed var(--text-muted);
            color: var(--text-muted);
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 24px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .calc-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 24px;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .calc-row.total {
            border-top: 1px solid var(--border);
            padding-top: 16px;
            margin-top: 8px;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .live-preview-area {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed var(--border);
        }

        #client-preview-text {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            height: 100px;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 10px;
            line-height: 1.5;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 24px;
        }

        .btn-action {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-save {
            background: var(--primary);
            color: white;
        }

        .btn-whatsapp {
            background: var(--whatsapp);
            color: white;
        }

        .btn-pdf {
            background: #fff;
            color: #000;
        }

        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: white;
            color: black;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 700;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        #toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* --- PDF LOADING OVERLAY --- */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #111;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #111;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- PDF GENERATION STYLES (Strict Single Page) --- */

        #pdf-container {
            position: fixed;
            top: 0;
            left: 100%;
            /* Off-screen */
            width: 210mm;
            height: 297mm;
            z-index: -9999;
            background: white;
            /* Forced clipping to guarantee 1 page */
            overflow: hidden;
            max-height: 297mm;
        }

        #pdf-container.generating {
            left: 0;
            top: 0;
        }

        .pdf-scope {
            --pdf-dark: #000;
            --pdf-gray: #555;
            --pdf-light: #f4f4f4;

            font-family: 'Inter', sans-serif !important;
            background: white;
            color: var(--pdf-dark);
            -webkit-print-color-adjust: exact;
        }

        .pdf-page {
            width: 210mm;
            height: 296mm;
            /* Strictly just under A4 height */
            background: white;
            padding: 10mm 15mm;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* PDF Header */
        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--pdf-dark);
        }

        .pdf-logo-img {
            height: 35px;
            width: auto;
            margin-bottom: 4px;
            display: block;
        }

        .pdf-client-info {
            text-align: right;
            font-size: 10px;
            line-height: 1.3;
            color: var(--pdf-gray);
        }

        .pdf-doc-title {
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: -0.5px;
            margin-bottom: 5px;
        }

        .pdf-highlight-box {
            display: inline-block;
            background: #000;
            color: #fff;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 10px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .pdf-intro {
            font-size: 10px;
            line-height: 1.4;
            color: var(--pdf-gray);
            margin-bottom: 15px;
            max-width: 95%;
        }

        /* Plan Box */
        .pdf-plan-box {
            border: 2px solid var(--pdf-dark);
            border-radius: 6px;
            padding: 15px 25px;
            background: #fff;
            margin-bottom: 15px;
        }

        .pdf-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .pdf-plan-name {
            font-size: 15px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .pdf-plan-desc {
            font-size: 10px;
            color: var(--pdf-gray);
            line-height: 1.3;
        }

        .pdf-price {
            font-size: 24px;
            font-weight: 800;
            color: var(--pdf-dark);
            line-height: 1;
        }

        .pdf-period {
            font-size: 9px;
            color: var(--pdf-gray);
            text-transform: uppercase;
            margin-top: 3px;
            font-weight: 600;
            text-align: right;
        }

        /* Features */
        .pdf-features-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px 15px;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .pdf-features-grid li {
            font-size: 10px;
            color: var(--pdf-dark);
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .pdf-features-grid li::before {
            content: "";
            width: 4px;
            height: 4px;
            background-color: var(--pdf-dark);
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }

        /* Report Table for Actuals */
        .pdf-report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .pdf-report-table th,
        .pdf-report-table td {
            text-align: left;
            padding: 8px 4px;
            font-size: 10px;
            border-bottom: 1px solid #eee;
        }

        .pdf-report-table th {
            text-transform: uppercase;
            font-weight: 700;
            color: var(--pdf-gray);
            border-bottom: 2px solid var(--pdf-dark);
        }

        .pdf-report-table td:last-child,
        .pdf-report-table th:last-child {
            text-align: right;
        }

        /* Footer */
        .pdf-notes {
            margin-bottom: 10px;
            padding: 8px 12px;
            background-color: var(--pdf-light);
            border-radius: 4px;
            font-size: 9px;
            color: var(--pdf-gray);
        }

        .pdf-total-section {
            /* FIXED: Removed auto margin to eliminate huge gap */
            margin-top: 40px;
            background: var(--pdf-dark);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-terms {
            font-size: 8px;
            opacity: 0.8;
            max-width: 65%;
            line-height: 1.3;
        }

        .pdf-sign {
            text-align: right;
        }

        .pdf-sign-name {
            font-weight: 700;
            font-size: 12px;
        }

        .pdf-sign-role {
            font-size: 8px;
            opacity: 0.7;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight: 600;">Processing...</div>
    </div>

    <div id="app">
        <!-- View: Months -->
        <div id="view-months" class="view active">
            <div class="brand-dashboard">
                <div class="db-status">
                    <div id="conn-dot" class="status-dot"></div>
                    <span id="conn-text">CHECKING...</span>
                </div>
                <div class="brand-header">
                    <div class="brand-logo">AO</div>
                    <div>
                        <div style="font-size: 1.2rem; font-weight: 700;">AIGFOX ORIGINALS</div>
                        <div style="font-size: 0.85rem; opacity: 0.8;">Production Manager</div>
                    </div>
                </div>
                <div class="brand-stats">
                    <div class="stat-item">
                        <h4>MONTHLY REVENUE</h4>
                        <p id="stat-revenue">‚Çπ0</p>
                    </div>
                    <div class="stat-item" style="text-align: right;">
                        <h4>PROJECTS</h4>
                        <p id="stat-active">0</p>
                    </div>
                </div>
            </div>
            <h1>Select Month</h1>
            <div id="months-list"></div>
        </div>

        <!-- View: Clients -->
        <div id="view-clients" class="view">
            <button class="nav-btn" onclick="router('months')">‚Üê Back</button>
            <h1 id="client-header">Clients</h1>
            <div id="clients-list"></div>
            <div class="card btn-add-card" onclick="openModal('modal-client')">
                <span>+ Add New Client</span>
            </div>
        </div>

        <!-- View: Projects -->
        <div id="view-projects" class="view">
            <button class="nav-btn" onclick="router('clients')">‚Üê Back</button>
            <h1 id="project-header">Projects</h1>
            <div id="projects-list"></div>
            <div class="card btn-add-card" onclick="openModal('modal-project')">
                <span>+ Add New Project</span>
            </div>
        </div>

        <!-- View: Details -->
        <div id="view-details" class="view">
            <button class="nav-btn" onclick="router('projects')">‚Üê Back</button>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1 id="detail-title" style="margin:0;">Project Details</h1>
                <button class="btn-del" onclick="handleDeleteCurrentProject()" style="padding:10px;">üóëÔ∏è</button>
            </div>

            <!-- TOGGLE SWITCH -->
            <div class="toggle-group" style="margin-top:20px;">
                <div id="toggle-est" class="toggle-option active" onclick="toggleViewMode('ESTIMATE')">
                    üìÑ Estimate
                </div>
                <div id="toggle-act" class="toggle-option" onclick="toggleViewMode('ACTUALS')">
                    üí∞ Actuals
                </div>
            </div>

            <!-- BUDGET DASHBOARD (New) -->
            <div class="budget-overview">
                <div class="budget-row">
                    <div>
                        <div class="b-label" style="opacity:0.8;">Budget:</div>
                        <div class="b-value" id="db-budget">‚Çπ0</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="b-label" style="opacity:0.8;">Spent:</div>
                        <div class="b-value" id="db-spent">‚Çπ0</div>
                    </div>
                </div>

                <div class="progress-track">
                    <div id="db-progress" class="progress-fill"></div>
                </div>

                <div class="remaining-text">
                    Remaining: <span id="db-remaining">‚Çπ0</span>
                </div>
            </div>

            <div style="margin-top:20px;">
                <label>Video Category</label>
                <div class="category-selector">
                    <div class="cat-btn" onclick="setCategory('CONCEPT', this)" id="cat-CONCEPT">CONCEPT</div>
                    <div class="cat-btn" onclick="setCategory('PROMOTIONAL', this)" id="cat-PROMOTIONAL">PROMO</div>
                    <div class="cat-btn" onclick="setCategory('BOTH', this)" id="cat-BOTH">BOTH</div>
                </div>
            </div>

            <div class="form-group">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <label style="margin:0;">Shoot Date</label>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="chk-unscheduled" style="width:auto; margin:0;"
                            onchange="toggleDateInput()">
                        <span style="font-size:0.75rem; color:var(--text-muted);">Unscheduled</span>
                    </div>
                </div>
                <input type="date" id="inp-date" oninput="calculate()">
            </div>

            <h2>Logistics</h2>
            <div class="logistics-grid">
                <div>
                    <label style="font-size:0.7rem; color:var(--text-muted);">Shoot Days</label>
                    <input type="number" id="inp-days" value="1" min="1" oninput="calculate()">
                </div>
                <div>
                    <label style="font-size:0.7rem; color:var(--text-muted);">Actors</label>
                    <input type="number" id="inp-actors" value="0" oninput="calculate()">
                </div>
                <div>
                    <label style="font-size:0.7rem; color:var(--text-muted);">Videos</label>
                    <input type="number" id="inp-videos" value="1" oninput="calculate()">
                </div>
                <div>
                    <label style="font-size:0.7rem; color:var(--text-muted);">Photos</label>
                    <input type="number" id="inp-photos" value="0" oninput="calculate()">
                </div>
            </div>

            <h2><span id="expenses-header">Expenses (Per Day)</span></h2>
            <div id="expenses-container"></div>
            <button class="btn-add-expense" onclick="addCustomExpenseRow()">+ Add Custom Expense</button>

            <!-- Calculation Card (Visible only in Estimate Mode) -->
            <div class="calc-card" id="estimate-calc-card">
                <div class="calc-row">
                    <span>Production Cost:</span>
                    <span id="val-prod">‚Çπ0</span>
                </div>
                <div class="calc-row" style="color:var(--text-muted); font-size:0.9rem;">
                    <span>Company Cut (20%):</span>
                    <span id="val-cut">‚Çπ0</span>
                </div>
                <div class="calc-row total">
                    <span>Grand Total:</span>
                    <span id="val-total">‚Çπ0</span>
                </div>
            </div>

            <!-- Calculation Card (Visible only in Actuals Mode) -->
            <div class="calc-card" id="actuals-calc-card" style="display:none;">
                <div class="calc-row">
                    <span>Actual Production Cost:</span>
                    <span id="val-act-prod">‚Çπ0</span>
                </div>
                <div class="calc-row" style="color:var(--text-muted); font-size:0.9rem;">
                    <span>Company Cut (Fixed from Est):</span>
                    <span id="val-act-cut">‚Çπ0</span>
                </div>
                <div class="calc-row total">
                    <span>Grand Total Spent:</span>
                    <span id="val-act-total">‚Çπ0</span>
                </div>
            </div>

            <div class="live-preview-area">
                <h2>Actions</h2>
                <div class="btn-group">
                    <button class="btn-action btn-save" onclick="saveData()">Save Changes</button>

                    <!-- PREVIEW PDF BUTTON -->
                    <button class="btn-action btn-pdf" onclick="generateProposal()">
                        üëÅÔ∏è Estimate Proposal (PDF)
                    </button>

                    <!-- REPORT PDF BUTTON (NEW) -->
                    <button class="btn-action btn-pdf"
                        style="background:#eef2ff; color:#312e81; border:1px solid #312e81;" onclick="generateReport()">
                        üìä Production Report (PDF)
                    </button>

                    <!-- WHATSAPP BUTTON -->
                    <button class="btn-action btn-whatsapp" onclick="sendWhatsApp('client')">
                        üí¨ Send via WhatsApp
                    </button>
                </div>

                <h2 style="margin-top:20px; font-size:0.9rem;">Raw Text Preview</h2>
                <textarea id="client-preview-text" readonly></textarea>
            </div>
        </div>
    </div>

    <!-- PDF TEMPLATE CONTAINER -->
    <div id="pdf-container">
        <!-- 1. ESTIMATE PROPOSAL TEMPLATE -->
        <div id="proposal-content" class="pdf-scope">
            <div class="pdf-page">
                <div class="pdf-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img src="aigfox_logo_2_black.png" alt="Aigfox Black Logo" class="pdf-logo-img"
                            style="margin-bottom: 0;">
                        <div style="line-height: 1;">
                            <div
                                style="color: #000; font-weight: 800; font-size: 28px; letter-spacing: -1px; font-family: 'Plus Jakarta Sans', sans-serif;">
                                AIGFOX</div>
                            <div
                                style="color: #000; font-weight: 400; font-size: 17px; letter-spacing: 2px; margin-left:1px; font-family: 'Plus Jakarta Sans', sans-serif;">
                                ORIGINALS</div>
                        </div>
                    </div>
                    <div class="pdf-client-info">
                        <strong>PREPARED FOR:</strong><br>
                        <span id="pdf-client-name">Client Name</span><br>
                        Ref: <span id="pdf-ref">#REP-000</span>
                    </div>
                </div>

                <div class="pdf-doc-title">Production Estimate</div>

                <div style="margin-bottom: 20px;">
                    <span class="pdf-highlight-box" id="pdf-date-box">SHOOT: OCT 23, 2025</span>
                    <span class="pdf-highlight-box" style="background:#444; margin-left: 5px;"
                        id="pdf-cat-box">PROMOTIONAL FILMS</span>
                </div>

                <div class="pdf-intro">
                    <strong>Hi Team,</strong><br>
                    Following up on our discussion, here is the scope for the upcoming schedule. Since we have the
                    assets from the previous shoot, we can move straight to production.
                </div>

                <div class="pdf-plan-box">
                    <div class="pdf-plan-header">
                        <div style="max-width: 60%;">
                            <div class="pdf-plan-name" id="pdf-project-name">Production Package</div>
                            <div class="pdf-plan-desc">Comprehensive content creation session including video,
                                photography, and post-production.</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="pdf-price" id="pdf-price">‚Çπ0</div>
                            <div class="pdf-period">Total Investment</div>
                        </div>
                    </div>

                    <ul class="pdf-features-grid" id="pdf-features">
                        <!-- Dynamic List Items will go here -->
                    </ul>
                </div>

                <div class="pdf-notes">
                    <strong>Note on High-End Production:</strong>
                    If you require the Cinema Package (Red Raptor/Multi-cam) for this specific campaign, the estimate
                    can be upgraded. Please let us know if you want to proceed with this tier instead.
                </div>

                <div class="pdf-total-section">
                    <div class="pdf-terms">
                        <strong>TERMS:</strong> 60% Advance to confirm booking. Balance due upon final delivery.
                        All raw files remain property of Aigfox until final settlement.
                    </div>
                    <div class="pdf-sign">
                        <div class="pdf-sign-name">Minhaj Sadique</div>
                        <div class="pdf-sign-role">Creative Director</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. PRODUCTION REPORT TEMPLATE (NEW) -->
        <div id="report-content" class="pdf-scope">
            <div class="pdf-page">
                <div class="pdf-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img src="aigfox_logo_2_black.png" alt="Aigfox Black Logo" class="pdf-logo-img"
                            style="margin-bottom: 0;">
                        <div style="line-height: 1;">
                            <div
                                style="color: #000; font-weight: 800; font-size: 28px; letter-spacing: -1px; font-family: 'Plus Jakarta Sans', sans-serif;">
                                AIGFOX</div>
                            <div
                                style="color: #000; font-weight: 400; font-size: 17px; letter-spacing: 2px; margin-left:1px; font-family: 'Plus Jakarta Sans', sans-serif;">
                                ORIGINALS</div>
                        </div>
                    </div>
                    <div class="pdf-client-info">
                        <strong>PRODUCTION REPORT</strong><br>
                        <span id="rpt-client-name">Client Name</span><br>
                        Date: <span id="rpt-date">Oct 23, 2025</span>
                    </div>
                </div>

                <div class="pdf-doc-title">Cost Summary</div>

                <div class="pdf-intro" style="margin-bottom: 20px;">
                    Below is the breakdown of the approved budget versus actual expenses incurred during production.
                </div>

                <!-- Report Table -->
                <table class="pdf-report-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Budget</th>
                            <th>Actual</th>
                        </tr>
                    </thead>
                    <tbody id="rpt-table-body">
                        <!-- Dynamic Rows -->
                    </tbody>
                </table>

                <div class="pdf-plan-box" style="background:#f9fafb; border:1px solid #ddd;">
                    <div class="pdf-plan-header" style="border:none; padding:0; margin:0; align-items:center;">
                        <div>
                            <div class="pdf-plan-name" style="font-size:12px;">Total Spent</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="pdf-price" id="rpt-total-spent" style="font-size:18px;">‚Çπ0</div>
                        </div>
                    </div>
                </div>

                <div class="pdf-total-section">
                    <div class="pdf-terms">
                        <strong>STATUS:</strong> <span id="rpt-status" style="font-weight: 800;">Under Budget</span>
                    </div>
                    <div class="pdf-sign">
                        <div class="pdf-sign-name">Abhiram Krishna</div>
                        <div class="pdf-sign-role">Creative Producer</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-client" class="modal-overlay">
        <div class="modal">
            <h3>New Client</h3>
            <input type="text" id="modal-client-name" placeholder="Client Name" style="margin-bottom:12px;">
            <input type="text" id="modal-project-name" placeholder="Initial Project Name">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-action" style="background:transparent; border:1px solid var(--border);"
                    onclick="closeModal()">Cancel</button>
                <button class="btn-action btn-save" onclick="submitNewClient()">Create</button>
            </div>
        </div>
    </div>

    <div id="modal-project" class="modal-overlay">
        <div class="modal">
            <h3>New Project</h3>
            <input type="text" id="modal-work-name" placeholder="Project Name">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-action" style="background:transparent; border:1px solid var(--border);"
                    onclick="closeModal()">Cancel</button>
                <button class="btn-action btn-save" onclick="submitNewProject()">Create</button>
            </div>
        </div>
    </div>

    <div id="toast">‚úÖ Action Successful</div>

    <script>
        // --- Configuration ---
        const SUPABASE_URL = "https://jtpsnufycomhozsiegjh.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0cHNudWZ5Y29taG96c2llZ2poIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5OTI5NjAsImV4cCI6MjA3NzU2ODk2MH0.SsKcUAjkv4gsTKawOfN-KKzYRkUKoQZj-JZDo8liggc";

        let supabaseClient = null;

        const state = {
            selectedMonth: null,
            selectedClient: null,
            selectedProject: null,
            expensesData: {}, // Structure: { "Category": { estimate: 0, actual: 0 } }
            customRows: [],
            allProjects: [],
            viewMode: 'ESTIMATE' // 'ESTIMATE' or 'ACTUALS'
        };

        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const baseCategories = ["Director", "Cinematographer", "Equipments Rent", "Food & Travel", "Other Crew", "Editors", "Props & Costume", "Other Miscellaneous"];

        // --- Initialization ---
        window.onload = () => {
            const dot = document.getElementById('conn-dot');
            const text = document.getElementById('conn-text');

            try {
                if (window.supabase) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    dot.classList.add('online');
                    text.innerText = "CONNECTED";
                } else {
                    dot.classList.add('offline');
                    text.innerText = "SUPABASE ERROR";
                }
            } catch (e) {
                dot.classList.add('offline');
                text.innerText = "CONNECTION ERROR";
            }

            renderMonths();
            loadDashboardStats();
        };

        async function loadDashboardStats() {
            if (!supabaseClient) return;
            const currentMonth = months[new Date().getMonth()];
            const { data } = await supabaseClient.from('projects')
                .select('*, expenses(amount)')
                .eq('month_name', currentMonth);

            if (data) {
                state.allProjects = data;
                const revenue = data.reduce((acc, p) => {
                    const base = p.expenses?.reduce((s, e) => s + (e.amount || 0), 0) || 0;
                    return acc + (base * (p.days || 1) * 1.2);
                }, 0);
                document.getElementById('stat-revenue').innerText = formatINR(revenue);
                document.getElementById('stat-active').innerText = data.length;
            }
        }

        // --- Navigation ---
        function router(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
            if (view === 'months') loadDashboardStats();
        }

        function renderMonths() {
            const list = document.getElementById('months-list');
            list.innerHTML = '';
            months.forEach(m => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `<span>${m}</span> <span style="color:var(--primary)">‚Ä∫</span>`;
                div.onclick = () => { state.selectedMonth = m; renderClients(); router('clients'); };
                list.appendChild(div);
            });
        }

        async function renderClients() {
            const list = document.getElementById('clients-list');
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">Loading...</div>';
            document.getElementById('client-header').innerText = `${state.selectedMonth} Clients`;

            if (!supabaseClient) { list.innerHTML = 'DB Connection Error'; return; }

            const { data: clients } = await supabaseClient.from('clients').select('*');
            const { data: projects } = await supabaseClient.from('projects').select('*').eq('month_name', state.selectedMonth);

            list.innerHTML = '';
            const activeClients = clients.filter(c => projects.some(p => p.client_id === c.id));

            if (activeClients.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">No clients for this month.</div>';
            }

            activeClients.forEach(c => {
                const pCount = projects.filter(p => p.client_id === c.id).length;
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                <div>
                    <div style="font-weight:600;">${c.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">${pCount} Projects</div>
                </div>
                <div style="display:flex; gap:15px; align-items:center;">
                    <button class="btn-del" title="Delete Client" onclick="event.stopPropagation(); handleDeleteClient('${c.id}')">üóëÔ∏è</button>
                    <span>‚Ä∫</span>
                </div>`;
                div.onclick = () => { state.selectedClient = c; renderProjects(); router('projects'); };
                list.appendChild(div);
            });
        }

        async function renderProjects() {
            const list = document.getElementById('projects-list');
            list.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';
            document.getElementById('project-header').innerText = state.selectedClient.name;

            if (!supabaseClient) return;
            const { data: projects } = await supabaseClient.from('projects').select('*, expenses(amount)').eq('client_id', state.selectedClient.id).eq('month_name', state.selectedMonth);

            list.innerHTML = '';
            projects.forEach(p => {
                const base = p.expenses.reduce((s, e) => s + e.amount, 0);
                const total = base * (p.days || 1) * 1.2;
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                <div>
                    <div style="font-weight:600;">${p.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">${p.category}</div>
                </div>
                <div style="text-align:right; display:flex; align-items:center; gap:15px;">
                    <div>
                        <div style="font-weight:700; color:var(--primary)">${formatINR(total)}</div>
                    </div>
                    <button class="btn-del" title="Delete Project" onclick="event.stopPropagation(); handleDeleteProject('${p.id}')">üóëÔ∏è</button>
                </div>`;
                div.onclick = () => { state.selectedProject = p; renderDetails(); router('details'); };
                list.appendChild(div);
            });
        }

        async function renderDetails() {
            const p = state.selectedProject;
            document.getElementById('detail-title').innerText = p.name;
            document.getElementById('inp-date').value = p.date || '';
            document.getElementById('inp-days').value = p.days || 1;
            document.getElementById('inp-actors').value = p.actors || 0;
            document.getElementById('inp-videos').value = p.videos || 1;
            document.getElementById('inp-photos').value = p.photos || 0;

            // 1. Initialize State immediately to prevent crashes in calculate()
            state.expensesData = {};
            state.customRows = [];
            baseCategories.forEach(cat => {
                state.expensesData[cat] = { estimate: 0, actual: 0 };
            });

            // Now safe to call functions that rely on expensesData
            setCategory(p.category || 'PROMOTIONAL', null);

            // Default to Estimate View when opening
            state.viewMode = 'ESTIMATE';
            updateViewUI();

            if (!supabaseClient) {
                // Even if offline, we need to render the empty list
                renderExpensesList();
                calculate();
                return;
            }

            // Fetch both amount (estimate) and actual_amount
            const { data: expenses } = await supabaseClient.from('expenses').select('*').eq('project_id', p.id);

            // 2. Populate from DB (Merge into existing state)
            if (expenses) {
                expenses.forEach(e => {
                    const catName = e.category_name;
                    // Add custom if not exists
                    if (!state.expensesData[catName]) {
                        state.expensesData[catName] = { estimate: 0, actual: 0 };
                        // Only add to custom rows if not a base category
                        if (!baseCategories.includes(catName)) {
                            state.customRows.push(catName);
                        }
                    }

                    // Set values
                    if (state.expensesData[catName]) {
                        state.expensesData[catName].estimate = e.amount || 0;
                        state.expensesData[catName].actual = e.actual_amount || 0;
                    }
                });
            }

            renderExpensesList();
            calculate();
        }

        function renderExpensesList() {
            const container = document.getElementById('expenses-container');
            container.innerHTML = '';

            // Combine base + custom for rendering
            const allCats = [...baseCategories, ...state.customRows];

            allCats.forEach(cat => {
                const data = state.expensesData[cat];
                if (!data) return; // Guard against undefined data

                const isMisc = cat === 'Other Miscellaneous';

                // Determine which value to show based on view mode
                // Guard property access
                const est = data.estimate || 0;
                const act = data.actual || 0;
                const valueToShow = state.viewMode === 'ESTIMATE' ? est : act;
                const isReadOnly = (isMisc && state.viewMode === 'ESTIMATE'); // Misc is auto-calc in Estimate

                const row = document.createElement('div');
                row.className = 'expense-row';

                // Custom row delete button logic
                let delBtn = '<div></div>';
                if (state.customRows.includes(cat)) {
                    delBtn = `<button class="btn-del" onclick="deleteExpense('${cat}')">√ó</button>`;
                }

                // If custom row, make name editable? No, simple for now.
                // Just inputs
                let labelHtml = `<label>${cat}</label>`;
                if (state.customRows.includes(cat)) {
                    labelHtml = `<input type="text" value="${cat}" placeholder="Name" onchange="renameCustom('${cat}', this.value)" style="text-align:left; background:transparent; padding:0;">`;
                }

                row.innerHTML = `
                    ${labelHtml}
                    <input type="number" 
                           value="${valueToShow}" 
                           ${isReadOnly ? 'readonly' : ''} 
                           oninput="updateCalc('${cat}', this.value)"
                           placeholder="0"
                    >
                    ${delBtn}
                `;
                row.id = 'row-' + cat.replace(/\s+/g, '-');
                container.appendChild(row);
            });
        }

        // --- View Toggling ---
        function toggleViewMode(mode) {
            state.viewMode = mode;
            updateViewUI();
            renderExpensesList(); // Re-render inputs
            calculate();
        }

        function updateViewUI() {
            // Toggle Buttons
            document.getElementById('toggle-est').className = state.viewMode === 'ESTIMATE' ? 'toggle-option active' : 'toggle-option';
            document.getElementById('toggle-act').className = state.viewMode === 'ACTUALS' ? 'toggle-option active' : 'toggle-option';

            // Headers
            document.getElementById('expenses-header').innerText = state.viewMode === 'ESTIMATE' ? "Estimated Expenses (Per Day)" : "Actual Expenses (Total)";

            // Show/Hide Estimate Calc Card
            document.getElementById('estimate-calc-card').style.display = state.viewMode === 'ESTIMATE' ? 'block' : 'none';
            document.getElementById('actuals-calc-card').style.display = state.viewMode === 'ACTUALS' ? 'block' : 'none';
        }

        // --- Logic ---
        function setCategory(cat, el) {
            state.selectedProject.category = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            if (el) el.classList.add('active');
            else document.getElementById('cat-' + cat)?.classList.add('active');
            calculate();
        }

        function addCustomExpenseRow(name = "", amt = 0) {
            const id = name || "Custom " + (state.customRows.length + 1);

            // Fix for "Cannot read properties of undefined (reading 'actual')"
            // Ensure we don't add duplicates or mess up state
            if (!state.expensesData[id]) {
                state.expensesData[id] = { estimate: 0, actual: 0 };
                // Only push to rows if it's new
                if (!state.customRows.includes(id)) {
                    state.customRows.push(id);
                }
            }

            renderExpensesList();
            calculate();
        }

        function renameCustom(oldId, newName) {
            if (!newName || state.expensesData[newName]) return; // Prevent dupes
            if (!state.expensesData[oldId]) return; // Guard

            // Move data
            state.expensesData[newName] = state.expensesData[oldId];
            delete state.expensesData[oldId];

            // Update list
            const idx = state.customRows.indexOf(oldId);
            if (idx !== -1) state.customRows[idx] = newName;

            // Re-render to update IDs and listeners
            renderExpensesList();
            calculate();
        }

        function deleteExpense(id) {
            if (state.expensesData[id]) {
                delete state.expensesData[id];
            }
            state.customRows = state.customRows.filter(r => r !== id);
            renderExpensesList();
            calculate();
        }

        function updateCalc(key, val) {
            const num = parseFloat(val) || 0;
            // Defensive Check
            if (!state.expensesData[key]) {
                state.expensesData[key] = { estimate: 0, actual: 0 };
            }

            if (state.viewMode === 'ESTIMATE') {
                state.expensesData[key].estimate = num;
            } else {
                state.expensesData[key].actual = num;
            }
            calculate();
        }

        function calculate() {
            const miscCat = 'Other Miscellaneous';
            // Guard against uninitialized state crash
            if (!state.expensesData || !state.expensesData[miscCat]) return;

            const days = parseFloat(document.getElementById('inp-days').value) || 1;

            // 1. Calculate Estimate Totals
            let estSubtotal = 0;
            for (let k in state.expensesData) {
                // Defensive check inside loop
                if (state.expensesData[k] && k !== miscCat) {
                    estSubtotal += (state.expensesData[k].estimate || 0);
                }
            }
            // Auto-calc Misc for Estimate
            const estMisc = estSubtotal * 0.10;
            state.expensesData[miscCat].estimate = estMisc;

            const totalProdCost = (estSubtotal + estMisc) * days;
            const companyCut = totalProdCost * 0.20;
            const grandTotalEst = totalProdCost + companyCut;

            // Update Estimate Card UI
            document.getElementById('val-prod').innerText = formatINR(totalProdCost);
            document.getElementById('val-cut').innerText = formatINR(companyCut);
            document.getElementById('val-total').innerText = formatINR(grandTotalEst);

            // Re-update misc input if visible
            if (state.viewMode === 'ESTIMATE') {
                const miscRow = document.getElementById('row-Other-Miscellaneous');
                if (miscRow) miscRow.querySelector('input').value = Math.round(estMisc);
            }

            // 2. Calculate Actuals Totals (Simple Sum)
            let totalActuals = 0;
            for (let k in state.expensesData) {
                if (state.expensesData[k]) {
                    totalActuals += (state.expensesData[k].actual || 0);
                }
            }

            // Update Actuals Card UI
            document.getElementById('val-act-total').innerText = "";


            // Update Actuals Card UI
            // Requirement: "company cut calculated in the estimation section should be same for the actuals section"
            // calc companyCut was calculated above
            const grandTotalAct = totalActuals + companyCut;

            document.getElementById('val-act-prod').innerText = formatINR(totalActuals);
            document.getElementById('val-act-cut').innerText = formatINR(companyCut);
            document.getElementById('val-act-total').innerText = formatINR(grandTotalAct);

            // 3. Update Dashboard
            updateDashboard(grandTotalEst, grandTotalAct);
            updateLivePreview(formatINR(grandTotalEst));
        }

        function updateDashboard(budget, spent) {
            document.getElementById('db-budget').innerText = formatINR(budget);
            document.getElementById('db-spent').innerText = formatINR(spent);

            const remaining = budget - spent;
            const remEl = document.getElementById('db-remaining');
            remEl.innerText = formatINR(remaining);
            remEl.style.color = remaining >= 0 ? 'var(--success)' : 'var(--danger)';

            // Progress Bar
            let pct = 0;
            if (budget > 0) pct = (spent / budget) * 100;
            if (pct > 100) pct = 100;

            const bar = document.getElementById('db-progress');
            bar.style.width = pct + '%';
            bar.style.backgroundColor = remaining >= 0 ? 'var(--success)' : 'var(--danger)';
        }

        function updateLivePreview(totalStr) {
            const p = state.selectedProject;
            if (!p) return;

            let t = `Quote from AIGFOX ORIGINALS\n\n`;
            t += `Project: ${p.name}\n`;
            t += `Type: ${p.category}\n`;
            t += `Shoot Days: ${document.getElementById('inp-days').value}\n\n`;
            t += `Breakdown:\n`;

            // Only showing estimates in whatsapp text for quote
            Object.entries(state.expensesData).forEach(([k, v]) => {
                if (v.estimate > 0) t += `* ${k}: ${formatINR(v.estimate)}\n`;
            });

            t += `\nTotal Quote: ${totalStr}`;
            document.getElementById('client-preview-text').value = t;
        }

        async function handleDeleteCurrentProject() {
            if (!confirm("Delete this project?")) return;
            await supabaseClient.from('projects').delete().eq('id', state.selectedProject.id);
            router('projects');
            renderProjects();
        }

        async function saveData() {
            if (!supabaseClient) return;
            const btn = document.querySelector('.btn-save');
            btn.innerText = "Saving...";

            const p = state.selectedProject;

            // Update Project Meta
            await supabaseClient.from('projects').update({
                date: document.getElementById('inp-date').value,
                days: document.getElementById('inp-days').value,
                actors: document.getElementById('inp-actors').value,
                videos: document.getElementById('inp-videos').value,
                photos: document.getElementById('inp-photos').value,
                category: p.category
            }).eq('id', p.id);

            // Update Expenses
            // Strategy: Delete all for project and re-insert. 
            // Since we hold all state in memory, this is safe and easy.
            await supabaseClient.from('expenses').delete().eq('project_id', p.id);

            const toInsert = Object.entries(state.expensesData).map(([name, data]) => ({
                project_id: p.id,
                category_name: name,
                amount: data.estimate,
                actual_amount: data.actual // NEW FIELD
            }));

            if (toInsert.length > 0) {
                await supabaseClient.from('expenses').insert(toInsert);
            }

            btn.innerText = "Save Changes";
            showToast("Changes Saved!");
        }

        // ... [Client/Project Create functions same as before] ...
        async function submitNewClient() {
            if (!supabaseClient) return;
            const name = document.getElementById('modal-client-name').value;
            const pName = document.getElementById('modal-project-name').value;
            if (!name || !pName) return;

            const { data: c } = await supabaseClient.from('clients').insert({ name }).select().single();
            await supabaseClient.from('projects').insert({
                client_id: c.id,
                name: pName,
                month_name: state.selectedMonth,
                category: 'PROMOTIONAL',
                days: 1,
                date: new Date().toISOString().split('T')[0]
            });

            closeModal();
            renderClients();
        }

        async function submitNewProject() {
            if (!supabaseClient) return;
            const name = document.getElementById('modal-work-name').value;
            if (!name) return;
            await supabaseClient.from('projects').insert({
                client_id: state.selectedClient.id,
                name: name,
                month_name: state.selectedMonth,
                category: 'PROMOTIONAL',
                days: 1,
                date: new Date().toISOString().split('T')[0]
            });
            closeModal();
            renderProjects();
        }

        async function handleDeleteClient(id) {
            if (!confirm("Delete this client and all their projects?")) return;
            await supabaseClient.from('clients').delete().eq('id', id);
            renderClients();
        }

        async function handleDeleteProject(id) {
            if (!confirm("Delete this project?")) return;
            await supabaseClient.from('projects').delete().eq('id', id);
            renderProjects();
        }

        function sendWhatsApp(target) {
            const text = document.getElementById('client-preview-text').value;
            const num = target === 'admin' ? "919562305524" : "";
            window.open(`https://wa.me/${num}?text=${encodeURIComponent(text)}`, '_blank');
        }

        // --- PDF GENERATOR (PROPOSAL) ---
        function generateProposal() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            const pdfContainer = document.getElementById('pdf-container');
            pdfContainer.classList.add('generating');

            // Inject Data
            const clientName = state.selectedClient ? state.selectedClient.name : "Client";
            const projName = state.selectedProject ? state.selectedProject.name : "Video Project";

            // Date Logic
            const isUnscheduled = document.getElementById('chk-unscheduled').checked;
            const dateRaw = document.getElementById('inp-date').value;
            let dateText = "SHOOT: DATE TBD";

            if (!isUnscheduled && dateRaw) {
                const dateObj = new Date(dateRaw);
                const formattedDate = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }).toUpperCase();
                dateText = `SHOOT: ${formattedDate}`;
            } else if (isUnscheduled) {
                dateText = "SHOOT: NON SCHEDULED";
            }

            document.getElementById('pdf-date-box').innerText = dateText;
            document.getElementById('pdf-client-name').innerText = clientName;
            document.getElementById('pdf-project-name').innerText = projName;
            document.getElementById('pdf-price').innerText = document.getElementById('val-total').innerText;

            const days = document.getElementById('inp-days').value;
            const videos = document.getElementById('inp-videos').value;
            const photos = document.getElementById('inp-photos').value;

            const featureList = document.getElementById('pdf-features');

            // Build Features List
            let listHtml = ``;
            listHtml += `<li>${days} Day Shoot Schedule</li>`;
            listHtml += `<li>${videos} High-Fidelity Reels/Videos</li>`;

            // Conditional Photo Line
            if (parseInt(photos) > 0) {
                listHtml += `<li>${photos} Edited High-Res Photos</li>`;
            }

            listHtml += `
            <li>Sony FX3 + a7 IV Cinema Kit</li>
            <li>Professional Editing & Color Grading</li>
            <li>Dedicated Creative Director</li>
            <li>Advanced Lighting Setup</li>
            <li>Full Licensing Rights</li>
            `;

            featureList.innerHTML = listHtml;

            const element = document.getElementById('proposal-content');
            const fileName = `${clientName}_${state.selectedMonth}_${projName}.pdf`;
            downloadPDF(element, fileName, overlay, pdfContainer);
        }

        function toggleDateInput() {
            const chk = document.getElementById('chk-unscheduled');
            const inp = document.getElementById('inp-date');
            if (chk.checked) {
                inp.disabled = true;
                inp.style.opacity = '0.5';
            } else {
                inp.disabled = false;
                inp.style.opacity = '1';
            }
        }

        // --- PDF GENERATOR (REPORT) ---
        function generateReport() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            const pdfContainer = document.getElementById('pdf-container');
            pdfContainer.classList.add('generating');

            // 1. Header Info
            const clientName = state.selectedClient ? state.selectedClient.name : "Client";
            document.getElementById('rpt-client-name').innerText = clientName;
            document.getElementById('rpt-date').innerText = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

            // 2. Build Table Rows
            const tbody = document.getElementById('rpt-table-body');
            tbody.innerHTML = '';

            // Rewrite Table Header to include P/L
            const thead = document.querySelector('.pdf-report-table thead tr');
            thead.innerHTML = `
                <th>Category</th>
                <th>Budget</th>
                <th>Actual</th>
                <th>P/L</th>
            `;

            let totalActual = 0;
            let totalBudget = 0;
            const days = parseFloat(document.getElementById('inp-days').value) || 1;

            // Sort so miscellaneous is last
            const sortedKeys = Object.keys(state.expensesData).sort((a, b) => a === 'Other Miscellaneous' ? 1 : -1);

            sortedKeys.forEach(key => {
                const data = state.expensesData[key];
                if (!data) return;

                // Logic: 
                // Misc works differently? No, in calculate() we derived it.
                // But here we need to READ the values generated/stored.
                // Note: calculate() runs on input, updating state.expensesData[misc].estimate.
                // So state is up to date.

                // Line item budget
                const lineBudget = data.estimate * ((key === 'Other Miscellaneous') ? 1 : days);
                // Wait! In calculate(): totalProdCost = (estSubtotal + estMisc) * days; 
                // This implies estMisc is per-day too? 
                // "const estMisc = estSubtotal * 0.10;" -> derived from per-day subtotal.
                // So yes, everything in expensesData is "Per Day".
                // EXCEPT: if the user concept is "Project-based". 
                // The prompt for calculating total was: `(estSubtotal + estMisc) * days`.
                // So to get total budget for line item, we multiply by days.

                const lineActual = data.actual || 0;
                // Wait, is "Actual" per day or total? 
                // The input placeholder says "Actual Expenses (Total)".
                // So `data.actual` is TOTAL. `data.estimate` is PER DAY.

                const finalBudget = data.estimate * days;
                const finalActual = data.actual || 0;

                totalBudget += finalBudget;
                totalActual += finalActual;

                const diff = finalBudget - finalActual;
                let plHtml = `<span style="color:#aaa;">-</span>`;
                if (Math.round(diff) > 0) plHtml = `<span style="color:var(--success);">+${formatINR(diff).replace('‚Çπ', '')}</span>`;
                if (Math.round(diff) < 0) plHtml = `<span style="color:var(--danger);">${formatINR(diff).replace('‚Çπ', '')}</span>`;

                if (finalBudget > 0 || finalActual > 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${key}</td>
                        <td>${formatINR(finalBudget)}</td>
                        <td>${formatINR(finalActual)}</td>
                        <td>${plHtml}</td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            // Add Company Cut Row
            // Company Cut is calculated from Budget.
            const cutValStr = document.getElementById('val-cut').innerText;
            const cutVal = parseFloat(cutValStr.replace(/[‚Çπ,]/g, '')) || 0;

            // Cut is fixed based on estimate as per user request
            const cutBudget = cutVal;
            const cutActual = cutVal; // Same for actuals

            totalBudget += cutBudget;
            totalActual += cutActual;

            const trCut = document.createElement('tr');
            trCut.style.backgroundColor = "#f9f9f9";
            trCut.style.fontWeight = "600";
            trCut.innerHTML = `
                <td>Company Cut (20%)</td>
                <td>${formatINR(cutBudget)}</td>
                <td>${formatINR(cutActual)}</td>
                <td>-</td>
            `;
            tbody.appendChild(trCut);

            // 3. Totals (Budget & Actual)
            // We want to show both.
            // Replace the simplistic total with a dual-column display
            const headerRight = document.querySelector('#report-content .pdf-plan-header > div:last-child');
            headerRight.innerHTML = `
                <div style="display:flex; gap:30px; text-align:right;">
                    <div>
                        <div style="font-size:9px; color:#666; font-weight:600; text-transform:uppercase;">Estimated</div>
                        <div style="font-size:18px; font-weight:800; color:#000;">${formatINR(totalBudget)}</div>
                    </div>
                    <div>
                        <div style="font-size:9px; color:#666; font-weight:600; text-transform:uppercase;">Actual</div>
                        <div style="font-size:18px; font-weight:800; color:#000;">${formatINR(totalActual)}</div>
                    </div>
                </div>
            `;

            //document.getElementById('rpt-total-spent').innerText = formatINR(totalActual);
            document.querySelector('.pdf-plan-name').innerText = "Grand Total";

            // 4. Status
            const statusEl = document.getElementById('rpt-status');
            const netDiff = totalBudget - totalActual;

            if (netDiff >= 0) {
                statusEl.innerHTML = `<span style="background:#22c55e; color:white; padding:4px 8px; border-radius:4px;">UNDER BUDGET (+${formatINR(netDiff)})</span>`;
            } else {
                statusEl.innerHTML = `<span style="background:#ef4444; color:white; padding:4px 8px; border-radius:4px;">OVER BUDGET (${formatINR(netDiff)})</span>`;
            }

            const element = document.getElementById('report-content');
            const fileName = `${clientName}_${state.selectedMonth}_${state.selectedProject?.name || 'Project'}_Report.pdf`;
            downloadPDF(element, fileName, overlay, pdfContainer);
        }

        function downloadPDF(element, filename, overlay, container) {
            const opt = {
                margin: 0,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            setTimeout(() => {
                html2pdf().set(opt).from(element).save()
                    .then(() => {
                        overlay.style.display = 'none';
                        container.classList.remove('generating');
                        showToast("PDF Downloaded!");
                    })
                    .catch(err => {
                        console.error(err);
                        overlay.style.display = 'none';
                        container.classList.remove('generating');
                        showToast("Error generating PDF");
                    });
            }, 500);
        }

        // --- Utils ---
        function formatINR(n) { return "‚Çπ" + Math.round(n).toLocaleString('en-IN'); }
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open')); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    </script>

</body>

</html>
