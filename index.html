<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Budget | AIGFOX ORIGINALS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-app: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --whatsapp: #25D366;
            --whatsapp-hover: #128C7E;
            --danger: #ef4444;
            --success: #22c55e;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        #app {
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            padding-bottom: 100px;
        }

        h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 24px; letter-spacing: -0.5px; }
        h2 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 16px; font-weight: 600; }
        
        .nav-btn {
            background: none; border: none; color: var(--text-muted); 
            display: flex; align-items: center; gap: 8px; 
            cursor: pointer; padding: 0; margin-bottom: 20px; font-weight: 500;
            transition: color 0.2s;
        }
        .nav-btn:hover { color: var(--text-main); }

        .view { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .view.active { display: block; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .brand-dashboard {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 30px;
            color: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .db-status {
            position: absolute; top: 20px; right: 20px;
            display: flex; align-items: center; gap: 6px;
            font-size: 0.65rem; font-weight: 700; color: var(--text-muted);
            background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 20px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-dot.offline { background: var(--danger); }

        .brand-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .brand-logo {
            width: 50px; height: 50px; background: rgba(255,255,255,0.2); 
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 1.2rem; backdrop-filter: blur(5px);
        }
        .brand-stats { display: flex; justify-content: space-between; }
        .stat-item h4 { font-size: 0.75rem; opacity: 0.8; font-weight: 500; margin: 0 0 4px 0; }
        .stat-item p { font-size: 1.25rem; font-weight: 700; margin: 0; }

        .btn-add-card {
            background: rgba(99, 102, 241, 0.05);
            border: 1px dashed var(--primary);
            color: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 1000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            width: 90%; max-width: 400px;
            padding: 24px;
            border-radius: 24px;
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.open .modal { transform: scale(1); }

        .category-selector { display: flex; gap: 8px; margin-bottom: 24px; }
        .cat-btn {
            flex: 1; background: var(--bg-input); border: 1px solid var(--border);
            color: var(--text-muted); padding: 12px 8px; border-radius: 12px; font-size: 0.75rem;
            cursor: pointer; transition: all 0.2s; font-weight: 600; text-align: center;
        }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; }
        
        input, select, textarea {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid transparent;
            color: white;
            padding: 14px;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
        }
        input:focus { border-color: var(--primary); }
        input[readonly] { background: rgba(0,0,0,0.1); color: var(--text-muted); }

        .logistics-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 24px;
        }

        .expense-row {
            display: grid; grid-template-columns: 1fr 100px 40px; gap: 10px; align-items: center; margin-bottom: 12px;
        }
        .expense-row label { font-size: 0.9rem; font-weight: 500; }
        .expense-row input { padding: 10px; }
        .btn-del { 
            background: none; border: none; color: var(--danger); 
            cursor: pointer; opacity: 0.6; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-del:hover { opacity: 1; }

        .btn-add-expense {
            background: transparent; border: 1px dashed var(--text-muted); color: var(--text-muted);
            width: 100%; padding: 12px; border-radius: 12px; margin-bottom: 24px;
            font-size: 0.9rem; cursor: pointer;
        }

        .calc-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 24px;
        }
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .calc-row.total { 
            border-top: 1px solid var(--border); 
            padding-top: 16px; margin-top: 8px;
            font-size: 1.25rem; font-weight: 700; color: var(--primary);
        }

        .live-preview-area {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed var(--border);
        }
        #client-preview-text {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            height: 220px;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 10px;
            line-height: 1.5;
        }

        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 24px; }
        .btn-action {
            width: 100%; padding: 16px; border-radius: 14px; font-size: 1rem; font-weight: 700;
            cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-save { background: var(--primary); color: white; }
        .btn-whatsapp { background: var(--whatsapp); color: white; }

        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: white; color: black; padding: 12px 24px; border-radius: 50px;
            font-weight: 700; opacity: 0; pointer-events: none; transition: all 0.3s;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 2000;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

<div id="app">
    <!-- View: Months -->
    <div id="view-months" class="view active">
        <div class="brand-dashboard">
            <div class="db-status">
                <div id="conn-dot" class="status-dot"></div>
                <span id="conn-text">CHECKING...</span>
            </div>
            <div class="brand-header">
                <div class="brand-logo">AO</div>
                <div>
                    <div style="font-size: 1.2rem; font-weight: 700;">AIGFOX ORIGINALS</div>
                    <div style="font-size: 0.85rem; opacity: 0.8;">Production Manager</div>
                </div>
            </div>
            <div class="brand-stats">
                <div class="stat-item">
                    <h4>MONTHLY REVENUE</h4>
                    <p id="stat-revenue">‚Çπ0</p>
                </div>
                <div class="stat-item" style="text-align: right;">
                    <h4>PROJECTS</h4>
                    <p id="stat-active">0</p>
                </div>
            </div>
        </div>
        <h1>Select Month</h1>
        <div id="months-list"></div>
    </div>

    <!-- View: Clients -->
    <div id="view-clients" class="view">
        <button class="nav-btn" onclick="router('months')">‚Üê Back</button>
        <h1 id="client-header">Clients</h1>
        <div id="clients-list"></div>
        <div class="card btn-add-card" onclick="openModal('modal-client')">
            <span>+ Add New Client</span>
        </div>
    </div>

    <!-- View: Projects -->
    <div id="view-projects" class="view">
        <button class="nav-btn" onclick="router('clients')">‚Üê Back</button>
        <h1 id="project-header">Projects</h1>
        <div id="projects-list"></div>
        <div class="card btn-add-card" onclick="openModal('modal-project')">
            <span>+ Add New Project</span>
        </div>
    </div>

    <!-- View: Details -->
    <div id="view-details" class="view">
        <button class="nav-btn" onclick="router('projects')">‚Üê Back</button>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 id="detail-title" style="margin:0;">Project Details</h1>
            <button class="btn-del" onclick="handleDeleteCurrentProject()" style="padding:10px;">üóëÔ∏è</button>
        </div>

        <div style="margin-top:20px;">
            <label>Video Category</label>
            <div class="category-selector">
                <div class="cat-btn" onclick="setCategory('CONCEPT', this)" id="cat-CONCEPT">CONCEPT</div>
                <div class="cat-btn" onclick="setCategory('PROMOTIONAL', this)" id="cat-PROMOTIONAL">PROMO</div>
                <div class="cat-btn" onclick="setCategory('BOTH', this)" id="cat-BOTH">BOTH</div>
            </div>
        </div>

        <div class="form-group">
            <label>Shoot Date</label>
            <input type="date" id="inp-date" oninput="calculate()">
        </div>

        <h2>Logistics</h2>
        <div class="logistics-grid">
            <div>
                <label style="font-size:0.7rem; color:var(--text-muted);">Shoot Days</label>
                <input type="number" id="inp-days" value="1" min="1" oninput="calculate()">
            </div>
            <div>
                <label style="font-size:0.7rem; color:var(--text-muted);">Actors</label>
                <input type="number" id="inp-actors" value="0" oninput="calculate()">
            </div>
            <div>
                <label style="font-size:0.7rem; color:var(--text-muted);">Videos</label>
                <input type="number" id="inp-videos" value="1" oninput="calculate()">
            </div>
            <div>
                <label style="font-size:0.7rem; color:var(--text-muted);">Photos</label>
                <input type="number" id="inp-photos" value="0" oninput="calculate()">
            </div>
        </div>

        <h2>Expenses (Per Day)</h2>
        <div id="expenses-container"></div>
        <button class="btn-add-expense" onclick="addCustomExpenseRow()">+ Add Custom Expense</button>

        <div class="calc-card">
            <div class="calc-row">
                <span>Production Cost:</span>
                <span id="val-prod">‚Çπ0</span>
            </div>
            <div class="calc-row" style="color:var(--text-muted); font-size:0.9rem;">
                <span>Company Cut (20%):</span>
                <span id="val-cut">‚Çπ0</span>
            </div>
            <div class="calc-row total">
                <span>Grand Total:</span>
                <span id="val-total">‚Çπ0</span>
            </div>
        </div>

        <div class="live-preview-area">
            <h2>WhatsApp Quote Preview</h2>
            <textarea id="client-preview-text" readonly></textarea>
        </div>

        <div class="btn-group">
            <button class="btn-action btn-save" onclick="saveData()">Save Changes</button>
            <button class="btn-action btn-whatsapp" onclick="sendWhatsApp('admin')">Send to Admin</button>
            <button class="btn-action btn-whatsapp" style="background:var(--text-main); color:var(--bg-app);" onclick="sendWhatsApp('client')">Send to Client</button>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="modal-client" class="modal-overlay">
    <div class="modal">
        <h3>New Client</h3>
        <input type="text" id="modal-client-name" placeholder="Client Name" style="margin-bottom:12px;">
        <input type="text" id="modal-project-name" placeholder="Initial Project Name">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-action" style="background:transparent; border:1px solid var(--border);" onclick="closeModal()">Cancel</button>
            <button class="btn-action btn-save" onclick="submitNewClient()">Create</button>
        </div>
    </div>
</div>

<div id="modal-project" class="modal-overlay">
    <div class="modal">
        <h3>New Project</h3>
        <input type="text" id="modal-work-name" placeholder="Project Name">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-action" style="background:transparent; border:1px solid var(--border);" onclick="closeModal()">Cancel</button>
            <button class="btn-action btn-save" onclick="submitNewProject()">Create</button>
        </div>
    </div>
</div>

<div id="toast">‚úÖ Action Successful</div>

<script>
    // --- Configuration ---
    const SUPABASE_URL = "https://jtpsnufycomhozsiegjh.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0cHNudWZ5Y29taG96c2llZ2poIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5OTI5NjAsImV4cCI6MjA3NzU2ODk2MH0.SsKcUAjkv4gsTKawOfN-KKzYRkUKoQZj-JZDo8liggc";

    let supabaseClient = null;

    const state = {
        selectedMonth: null,
        selectedClient: null,
        selectedProject: null,
        expensesData: {},
        customRows: [],
        allProjects: []
    };

    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const baseCategories = ["Director", "Cinematographer", "Equipments Rent", "Food & Travel", "Other Crew", "Editors", "Props & Costume", "Other Miscellaneous"];

    // --- Initialization ---
    window.onload = () => {
        const dot = document.getElementById('conn-dot');
        const text = document.getElementById('conn-text');
        
        try {
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                dot.classList.add('online');
                text.innerText = "CONNECTED";
            } else {
                dot.classList.add('offline');
                text.innerText = "SUPABASE ERROR";
            }
        } catch (e) { 
            dot.classList.add('offline');
            text.innerText = "CONNECTION ERROR";
        }
        
        renderMonths();
        loadDashboardStats();
    };

    async function loadDashboardStats() {
        if (!supabaseClient) return;
        
        // Filter logic: Only get projects for the current system month for the "Monthly" label
        const currentMonth = months[new Date().getMonth()];
        const { data } = await supabaseClient.from('projects')
            .select('*, expenses(amount)')
            .eq('month_name', currentMonth);

        if (data) {
            state.allProjects = data;
            const revenue = data.reduce((acc, p) => {
                const base = p.expenses?.reduce((s, e) => s + (e.amount || 0), 0) || 0;
                return acc + (base * (p.days || 1) * 1.2);
            }, 0);
            document.getElementById('stat-revenue').innerText = formatINR(revenue);
            document.getElementById('stat-active').innerText = data.length;
        }
    }

    // --- Navigation ---
    function router(view) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        if(view === 'months') loadDashboardStats();
    }

    function renderMonths() {
        const list = document.getElementById('months-list');
        list.innerHTML = '';
        months.forEach(m => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `<span>${m}</span> <span style="color:var(--primary)">‚Ä∫</span>`;
            div.onclick = () => { state.selectedMonth = m; renderClients(); router('clients'); };
            list.appendChild(div);
        });
    }

    async function renderClients() {
        const list = document.getElementById('clients-list');
        list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">Loading...</div>';
        document.getElementById('client-header').innerText = `${state.selectedMonth} Clients`;

        if (!supabaseClient) { list.innerHTML = 'DB Connection Error'; return; }

        const { data: clients } = await supabaseClient.from('clients').select('*');
        const { data: projects } = await supabaseClient.from('projects').select('*').eq('month_name', state.selectedMonth);

        list.innerHTML = '';
        const activeClients = clients.filter(c => projects.some(p => p.client_id === c.id));

        if (activeClients.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted)">No clients for this month.</div>';
        }

        activeClients.forEach(c => {
            const pCount = projects.filter(p => p.client_id === c.id).length;
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div>
                    <div style="font-weight:600;">${c.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">${pCount} Projects</div>
                </div>
                <div style="display:flex; gap:15px; align-items:center;">
                    <button class="btn-del" title="Delete Client" onclick="event.stopPropagation(); handleDeleteClient('${c.id}')">üóëÔ∏è</button>
                    <span>‚Ä∫</span>
                </div>`;
            div.onclick = () => { state.selectedClient = c; renderProjects(); router('projects'); };
            list.appendChild(div);
        });
    }

    async function renderProjects() {
        const list = document.getElementById('projects-list');
        list.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';
        document.getElementById('project-header').innerText = state.selectedClient.name;

        if (!supabaseClient) return;
        const { data: projects } = await supabaseClient.from('projects').select('*, expenses(amount)').eq('client_id', state.selectedClient.id).eq('month_name', state.selectedMonth);
        
        list.innerHTML = '';
        projects.forEach(p => {
            const base = p.expenses.reduce((s, e) => s + e.amount, 0);
            const total = base * (p.days || 1) * 1.2;
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div>
                    <div style="font-weight:600;">${p.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">${p.category}</div>
                </div>
                <div style="text-align:right; display:flex; align-items:center; gap:15px;">
                    <div>
                        <div style="font-weight:700; color:var(--primary)">${formatINR(total)}</div>
                    </div>
                    <button class="btn-del" title="Delete Project" onclick="event.stopPropagation(); handleDeleteProject('${p.id}')">üóëÔ∏è</button>
                </div>`;
            div.onclick = () => { state.selectedProject = p; renderDetails(); router('details'); };
            list.appendChild(div);
        });
    }

    async function renderDetails() {
        const p = state.selectedProject;
        document.getElementById('detail-title').innerText = p.name;
        document.getElementById('inp-date').value = p.date || '';
        document.getElementById('inp-days').value = p.days || 1;
        document.getElementById('inp-actors').value = p.actors || 0;
        document.getElementById('inp-videos').value = p.videos || 1;
        document.getElementById('inp-photos').value = p.photos || 0;

        setCategory(p.category || 'PROMOTIONAL', null);

        if (!supabaseClient) return;
        const { data: expenses } = await supabaseClient.from('expenses').select('*').eq('project_id', p.id);
        
        const container = document.getElementById('expenses-container');
        container.innerHTML = '';
        state.expensesData = {};
        state.customRows = [];

        baseCategories.forEach(cat => {
            const ex = expenses.find(e => e.category_name === cat);
            const val = ex ? ex.amount : 0;
            state.expensesData[cat] = val;
            
            const row = document.createElement('div');
            row.className = 'expense-row';
            row.innerHTML = `<label>${cat}</label><input type="number" value="${val}" ${cat === 'Other Miscellaneous' ? 'readonly' : ''} oninput="updateCalc('${cat}', this.value)"><div></div>`;
            container.appendChild(row);
        });

        expenses.filter(e => !baseCategories.includes(e.category_name)).forEach(e => {
            addCustomExpenseRow(e.category_name, e.amount);
        });

        calculate();
    }

    // --- Logic ---
    function setCategory(cat, el) {
        state.selectedProject.category = cat;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if (el) el.classList.add('active');
        else document.getElementById('cat-' + cat)?.classList.add('active');
        calculate();
    }

    function addCustomExpenseRow(name = "", amt = 0) {
        const id = name || "Custom_" + Date.now();
        if(!name) state.customRows.push(id);
        state.expensesData[id] = amt;

        const container = document.getElementById('expenses-container');
        const row = document.createElement('div');
        row.className = 'expense-row';
        row.id = 'row-' + id;
        row.innerHTML = `
            <input type="text" value="${name}" placeholder="Expense Name" onchange="renameCustom('${id}', this.value)">
            <input type="number" value="${amt}" oninput="updateCalc('${id}', this.value)">
            <button class="btn-del" onclick="deleteExpense('${id}')">√ó</button>
        `;
        container.appendChild(row);
        calculate();
    }

    function renameCustom(oldId, newName) {
        if (!newName) return;
        const val = state.expensesData[oldId];
        delete state.expensesData[oldId];
        state.expensesData[newName] = val;
        
        const index = state.customRows.indexOf(oldId);
        if(index > -1) state.customRows[index] = newName;

        const row = document.getElementById('row-' + oldId);
        row.id = 'row-' + newName;
        const inputs = row.querySelectorAll('input');
        inputs[1].setAttribute('oninput', `updateCalc('${newName}', this.value)`);
        calculate();
    }

    function deleteExpense(id) {
        delete state.expensesData[id];
        state.customRows = state.customRows.filter(r => r !== id);
        document.getElementById('row-' + id)?.remove();
        calculate();
    }

    function updateCalc(key, val) {
        state.expensesData[key] = parseFloat(val) || 0;
        calculate();
    }

    function calculate() {
        let subtotal = 0;
        for (let k in state.expensesData) {
            if (k !== 'Other Miscellaneous') subtotal += state.expensesData[k];
        }

        const misc = subtotal * 0.10;
        state.expensesData['Other Miscellaneous'] = misc;
        
        const inputs = document.querySelectorAll('.expense-row input[readonly]');
        if(inputs.length) inputs[0].value = Math.round(misc);

        const days = parseFloat(document.getElementById('inp-days').value) || 1;
        const totalProd = (subtotal + misc) * days;
        const cut = totalProd * 0.20;
        const grand = totalProd + cut;

        document.getElementById('val-prod').innerText = formatINR(totalProd);
        document.getElementById('val-cut').innerText = formatINR(cut);
        const totalStr = formatINR(grand);
        document.getElementById('val-total').innerText = totalStr;

        updateLivePreview(totalStr);
    }

    function updateLivePreview(totalStr) {
        const p = state.selectedProject;
        if(!p) return;

        let t = `Quote from AIGFOX ORIGINALS\n\n`;
        t += `Project: ${p.name}\n`;
        t += `Type: ${p.category}\n`;
        t += `Shoot Days: ${document.getElementById('inp-days').value}\n\n`;
        t += `Breakdown:\n`;
        
        Object.entries(state.expensesData).forEach(([k, v]) => {
            if(v > 0) t += `* ${k}: ${formatINR(v)}\n`;
        });

        t += `\nTotal Quote: ${totalStr}`;
        document.getElementById('client-preview-text').value = t;
    }

    async function handleDeleteClient(id) {
        if(!confirm("Delete this client and all their projects?")) return;
        await supabaseClient.from('clients').delete().eq('id', id);
        renderClients();
    }

    async function handleDeleteProject(id) {
        if(!confirm("Delete this project?")) return;
        await supabaseClient.from('projects').delete().eq('id', id);
        renderProjects();
    }

    async function handleDeleteCurrentProject() {
        if(!confirm("Delete this project?")) return;
        await supabaseClient.from('projects').delete().eq('id', state.selectedProject.id);
        router('projects');
        renderProjects();
    }

    async function saveData() {
        if (!supabaseClient) return;
        const btn = document.querySelector('.btn-save');
        btn.innerText = "Saving...";
        
        const p = state.selectedProject;
        await supabaseClient.from('projects').update({
            date: document.getElementById('inp-date').value,
            days: document.getElementById('inp-days').value,
            actors: document.getElementById('inp-actors').value,
            videos: document.getElementById('inp-videos').value,
            photos: document.getElementById('inp-photos').value,
            category: p.category
        }).eq('id', p.id);

        await supabaseClient.from('expenses').delete().eq('project_id', p.id);
        
        const toInsert = Object.entries(state.expensesData).map(([name, amt]) => ({
            project_id: p.id,
            category_name: name,
            amount: amt
        }));
        
        await supabaseClient.from('expenses').insert(toInsert);
        
        btn.innerText = "Save Changes";
        showToast("Changes Saved!");
    }

    async function submitNewClient() {
        if (!supabaseClient) return;
        const name = document.getElementById('modal-client-name').value;
        const pName = document.getElementById('modal-project-name').value;
        if (!name || !pName) return;

        const { data: c } = await supabaseClient.from('clients').insert({ name }).select().single();
        await supabaseClient.from('projects').insert({
            client_id: c.id,
            name: pName,
            month_name: state.selectedMonth,
            category: 'PROMOTIONAL',
            days: 1,
            date: new Date().toISOString().split('T')[0]
        });

        closeModal();
        renderClients();
    }

    async function submitNewProject() {
        if (!supabaseClient) return;
        const name = document.getElementById('modal-work-name').value;
        if (!name) return;
        await supabaseClient.from('projects').insert({
            client_id: state.selectedClient.id,
            name: name,
            month_name: state.selectedMonth,
            category: 'PROMOTIONAL',
            days: 1,
            date: new Date().toISOString().split('T')[0]
        });
        closeModal();
        renderProjects();
    }

    function sendWhatsApp(target) {
        const text = document.getElementById('client-preview-text').value;
        const num = target === 'admin' ? "919562305524" : "";
        window.open(`https://wa.me/${num}?text=${encodeURIComponent(text)}`, '_blank');
    }

    // --- Utils ---
    function formatINR(n) { return "‚Çπ" + Math.round(n).toLocaleString('en-IN'); }
    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open')); }
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }
</script>

</body>
</html>
